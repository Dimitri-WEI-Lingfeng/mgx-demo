# Project target
MGX: A PaaS demo with agent generated web app

# Definition
- MGX: The Platform name where agent develop and deploy apps
- App: a web app generated by agent
- Workspace: a directory for a app's code
- app-dev-container: a container for running a app's dev servers
- agent team: a team of agents for generating web app code

# Project features
- MGX UI 
    - start session to chat with agent team
    - one session to one app
    - agent team study and generate web app code
    - Generated backend and frontend code in one workspace dir
    - both user and agent can view and edit the code
    - app's user management
    - app's database management
    - app production log
    - readonly terminal for app's containers 
    - ssh access to app-dev-container for development
- MGX provide oauth2 provider for apps
    - supported methods:
        - user password
    - MGX's own authentication use the same oauth2 provider
- Supported frameworks with template:
    - Next.js
    - Fastapi + React Vite SPA
    these templates include:
        - oauth2 auth with MGX provider
        - MongoDB basic collections and connection codes
            - user
        - OpenTelemetry tracing and logging
- Build and deploy production images with docker api
    - if fullstack framework, build and deploy in one container
    - else build and deploy separately

- Proxy apps under MGX domain subpath (url friendly app name) 
## Limitation
- only deploy app in single instance mode (one container for backend and one container for frontend, or one container for both)
- no https
- no multi-tenant

# Project architecture
- MGX frontend (React SPA)
- MGX gateway (apisix docker)
    - only proxy
    - no authentication
- MGX app backend (FastAPI)
    - oauth2 provider
    - user management
    - chat and session management
    - gateway management (apisix sdk)
    - workspace management
    - manage app-dev-container with local mounted volume for workspace
    - use celery to run agent in isolated containers with app's workspace volume
    - manage database and storage
    - build and deploy production environment
- Docker container and volume for running app-dev-servers
- Agent
- task queue
- Redis for celery
- MongoDB for MGX and agent
- MongoDB for Apps

## Architecture diagrams

### 1. 系统总体架构

```mermaid
flowchart TB
    subgraph User["用户"]
        Browser[浏览器]
    end

    subgraph MGX["MGX 平台"]
        subgraph MGX_Frontend["MGX Frontend"]
            UI[React SPA]
        end
        subgraph Gateway["MGX Gateway"]
            Apisix[Apisix<br/>仅代理 / 无鉴权]
        end
        subgraph MGX_Backend["MGX Backend Services"]
            subgraph MGX_API["MGX API (FastAPI) - 多实例"]
                Api1[mgx-api-1]
                Api2[mgx-api-2]
                ApiN[mgx-api-n]
            end
            OAuth2[OAuth2 Provider<br/>独立服务]
        end
    end

    subgraph Runtime["运行时"]
        subgraph Agent_Scheduler["Agent 运行时"]
            Celery[Celery Task Queue]
            Agent[Agent Team<br/>langchain multiagents]
        end
        subgraph App_Dev["App 开发环境"]
            DevContainer[app-dev-container]
            Workspace[Workspace<br/>代码目录]
        end
        subgraph App_Prod["App 生产环境"]
            ProdContainer[app 生产容器]
        end
    end

    subgraph Data["数据层"]
        Redis[(Redis<br/>Celery)]
        MongoMGX[(MongoDB<br/>MGX & Agent)]
        MongoApps[(MongoDB<br/>Apps)]
    end

    Browser --> UI
    UI --> Apisix
    Apisix --> Api1
    Apisix --> Api2
    Apisix --> ApiN
    Apisix --> OAuth2
    Apisix --> DevContainer
    Apisix --> ProdContainer
    DevContainer -.->|OAuth2 Client| OAuth2
    ProdContainer -.->|OAuth2 Client| OAuth2
    Api1 -.->|鉴权/Token 校验| OAuth2
    Api2 -.->|鉴权/Token 校验| OAuth2
    ApiN -.->|鉴权/Token 校验| OAuth2
    Api1 -->|读写代码文件| Workspace
    Api2 -->|读写代码文件| Workspace
    ApiN -->|读写代码文件| Workspace
    Api1 --> Celery
    Api1 --> Redis
    Api1 --> MongoMGX
    Api1 --> MongoApps
    Api1 -.->|管理/编排| DevContainer
    Api1 -.->|管理/编排| ProdContainer
    OAuth2 --> MongoMGX
    Celery --> Agent
    Agent --> Workspace
    DevContainer --> Workspace
```

### 2. 请求与数据流（会话 → Agent → Workspace）

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as MGX Frontend
    participant G as Gateway (Apisix)
    participant O as OAuth2 Provider
    participant B as MGX API (FastAPI)
    participant Q as Celery
    participant A as Agent 容器
    participant W as Workspace
    participant DB as MongoDB

    U->>F: 登录 / 获取 Token
    F->>G: /oauth2/...
    G->>O: 代理
    O->>DB: 用户/授权数据
    O-->>F: Token

    U->>F: 在代码编辑器打开文件
    F->>G: /api/workspaces/{id}/files/...（携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>W: 读取文件内容
    W-->>B: 文件内容
    B-->>F: 返回文件内容

    U->>F: 保存文件
    F->>G: /api/workspaces/{id}/files/...（PUT，携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>W: 写入文件内容
    W-->>B: 写入结果
    B-->>F: 保存成功

    U->>F: 发起会话 / 聊天
    F->>G: HTTP（携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>DB: 会话 & 用户
    B->>Q: 投递 Agent 任务
    Q->>A: 在隔离容器中执行
    A->>W: 读写代码（挂载卷）
    A->>B: 任务结果
    B->>F: 流式/结果
    F->>U: 展示 & 代码编辑
```

### 3. MGX Backend 与周边组件

```mermaid
flowchart LR
    subgraph MGX_API["MGX API (FastAPI)"]
        UserMgmt[用户管理]
        Chat[会话与聊天]
        GatewayMgmt[网关管理<br/>Apisix SDK]
        WorkspaceMgmt[Workspace 管理<br/>文件读写/代码编辑 API]
        DevContainerMgmt[app-dev-container 管理]
        AgentOrchestrator[Celery / Agent 编排]
        DBMgmt[数据库与存储管理]
        BuildDeploy[构建与部署]
    end

    OAuth2[OAuth2 Provider<br/>独立服务]
    Apisix[Apisix]
    Redis[(Redis)]
    MongoMGX[(MongoDB MGX)]
    MongoApps[(MongoDB Apps)]
    Docker[Docker<br/>容器与卷]
    Workspace[(Workspace<br/>本地挂载卷)]

    OAuth2 --> MongoMGX
    MGX_API -.->|鉴权/Token 校验| OAuth2
    UserMgmt --> MongoMGX
    Chat --> MongoMGX
    GatewayMgmt --> Apisix
    WorkspaceMgmt -->|读写文件| Workspace
    DevContainerMgmt --> Docker
    AgentOrchestrator --> Redis
    AgentOrchestrator --> Docker
    DBMgmt --> MongoMGX
    DBMgmt --> MongoApps
    BuildDeploy --> Docker
```

### 4. App 从开发到生产

```mermaid
flowchart TB
    subgraph Session["会话"]
        S1[一个 Session = 一个 App]
    end

    subgraph Dev["开发阶段"]
        W[Workspace<br/>前后端代码]
        DC[app-dev-container<br/>挂载 Workspace]
        DC --> W
    end

    subgraph Prod["生产阶段"]
        direction TB
        P1[全栈框架<br/>单容器]
        P2[前后端分离<br/>Backend 容器 + Frontend 容器]
    end

    Apisix[Apisix Gateway]

    S1 --> W
    W --> P1
    W --> P2
    Apisix --> DC
    Apisix --> P1
    Apisix --> P2
```

### 5. 部署与访问形态（App 单实例 + 子路径）

```mermaid
flowchart LR
    subgraph Internet["访问"]
        User[用户]
    end

    G[Apisix Gateway]

    subgraph Deploy["部署形态"]
        MGX_Fe[MGX Frontend]
        subgraph MGX_BE["MGX API 多实例"]
            MGX_Be1[mgx-api-1]
            MGX_Be2[mgx-api-2]
            MGX_BeN[mgx-api-n]
        end
        OAuth2[OAuth2 Provider]
        AppA_Container[App A 容器]
        AppB_Container[App B 容器]
    end

    User --> G
    G -->|"/"| MGX_Fe
    G -->|"/api/..."| MGX_Be1
    G -->|"/api/..."| MGX_Be2
    G -->|"/api/..."| MGX_BeN
    G -->|"/oauth2/..."| OAuth2
    G -->|"/apps/app-a/..."| AppA_Container
    G -->|"/apps/app-b/..."| AppB_Container

    MGX_Fe -.->|OAuth2 Client| OAuth2
    MGX_Be1 -.->|鉴权/Token 校验| OAuth2
    MGX_Be2 -.->|鉴权/Token 校验| OAuth2
    MGX_BeN -.->|鉴权/Token 校验| OAuth2
    AppA_Container -.->|OAuth2 Client| OAuth2
    AppB_Container -.->|OAuth2 Client| OAuth2
```

### 6. App 使用 MGX OAuth2 Provider（示意时序）

```mermaid
sequenceDiagram
    participant U as 用户
    participant A as App（Frontend/Backend）
    participant G as Apisix
    participant O as OAuth2 Provider（MGX）

    U->>A: 访问 App（/apps/{name}/...）
    A-->>U: 需要登录/无 Token
    U->>G: /oauth2/...（登录/授权）
    G->>O: 代理到 OAuth2 Provider
    O-->>U: 返回 Token（或回调到 App）
    U->>A: 携带 Token 重新访问
    A->>O: 校验 Token（例如 JWKS/Introspection）
    O-->>A: 校验结果/公钥
    A-->>U: 返回受保护资源
```

# Tech stack
- MGX frontend: React SPA
- MGX backend: Fastapi
- Agent framework: langchain multiagents (https://github.com/FoundationAgents/langchain multiagents)
- agent runtime: docker container
- MGX Database: MongoDB
- Gateway: Apisix
- Container: Docker
- trace and logging: opentelemetry