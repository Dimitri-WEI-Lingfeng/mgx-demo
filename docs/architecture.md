# Project target
MGX: A PaaS demo with agent generated web app

# Definition
- MGX: The Platform name where agent develop and deploy apps
- App: a web app generated by agent
- Workspace: a directory for a app's code
- app-dev-container: a container for running a app's dev servers
- agent team: a team of agents for generating web app code

# Project features
- MGX UI 
    - start session to chat with agent team
    - one session to one app
    - agent team study and generate web app code
    - Generated backend and frontend code in one workspace dir
    - both user and agent can view and edit the code
    - app's user management
    - app's database management
    - app production log
    - readonly terminal for app's containers 
    - ssh access to app-dev-container for development
- MGX provide oauth2 provider for apps
    - supported methods:
        - user password
    - MGX's own authentication use the same oauth2 provider
- Supported frameworks with template:
    - Next.js
    - Fastapi + React Vite SPA
    these templates include:
        - oauth2 auth with MGX provider
        - MongoDB basic collections and connection codes
            - user
        - OpenTelemetry tracing and logging
- Build and deploy production images with docker api
    - if fullstack framework, build and deploy in one container
    - else build and deploy separately

- Proxy apps under MGX domain subpath (url friendly app name) 
## Limitation
- only deploy app in single instance mode (one container for backend and one container for frontend, or one container for both)
- no https
- no multi-tenant

# Project architecture
- MGX frontend (React SPA)
- MGX gateway (apisix docker)
    - only proxy
    - no authentication
- MGX app backend (FastAPI)
    - oauth2 provider
    - user management
    - chat and session management
    - gateway management (apisix sdk)
    - workspace management
    - manage app-dev-container with local mounted volume for workspace
    - use celery to orchestrate agent containers
    - manage database and storage
    - build and deploy production environment
- Docker container and volume for running app-dev-servers
- Agent container (独立运行)
    - 每个 session 在独立容器中运行 agent
    - Agent 直接读写 workspace 文件（通过挂载卷）
    - Agent 将事件写入 MongoDB
    - 容器运行完成后自动删除
- Celery task queue
    - 创建和启动 agent 容器
    - 轮询 event 表监控 agent 完成状态
    - 处理超时和错误
- Redis for celery
- MongoDB for MGX and agent
- MongoDB for Apps

## Architecture diagrams

### 1. 系统总体架构

```mermaid
flowchart TB
    subgraph User["用户"]
        Browser[浏览器]
    end

    subgraph MGX["MGX 平台"]
        subgraph MGX_Frontend["MGX Frontend"]
            UI[React SPA]
        end
        subgraph Gateway["MGX Gateway"]
            Apisix[Apisix<br/>仅代理 / 无鉴权]
        end
        subgraph MGX_Backend["MGX Backend Services"]
            subgraph MGX_API["MGX API (FastAPI) - 多实例"]
                Api1[mgx-api-1]
                Api2[mgx-api-2]
                ApiN[mgx-api-n]
            end
            OAuth2[OAuth2 Provider<br/>独立服务]
        end
    end

    subgraph Runtime["运行时"]
        subgraph Agent_Scheduler["Agent 运行时"]
            Celery[Celery Task Queue<br/>编排与监控]
            AgentContainer[Agent Container<br/>独立容器运行 agent]
        end
        subgraph App_Dev["App 开发环境"]
            DevContainer[app-dev-container]
            Workspace[Workspace<br/>代码目录]
        end
        subgraph App_Prod["App 生产环境"]
            ProdContainer[app 生产容器]
        end
    end

    subgraph Data["数据层"]
        Redis[(Redis<br/>Celery)]
        MongoMGX[(MongoDB<br/>MGX & Agent)]
        MongoApps[(MongoDB<br/>Apps)]
    end

    Browser --> UI
    UI --> Apisix
    Apisix --> Api1
    Apisix --> Api2
    Apisix --> ApiN
    Apisix --> OAuth2
    Apisix --> DevContainer
    Apisix --> ProdContainer
    DevContainer -.->|OAuth2 Client| OAuth2
    ProdContainer -.->|OAuth2 Client| OAuth2
    Api1 -.->|鉴权/Token 校验| OAuth2
    Api2 -.->|鉴权/Token 校验| OAuth2
    ApiN -.->|鉴权/Token 校验| OAuth2
    Api1 -->|读写代码文件| Workspace
    Api2 -->|读写代码文件| Workspace
    ApiN -->|读写代码文件| Workspace
    Api1 --> Celery
    Api1 --> Redis
    Api1 --> MongoMGX
    Api1 --> MongoApps
    Api1 -.->|管理/编排| DevContainer
    Api1 -.->|管理/编排| ProdContainer
    OAuth2 --> MongoMGX
    Celery -.->|创建与监控| AgentContainer
    AgentContainer -->|读写代码| Workspace
    AgentContainer -->|写入事件| MongoMGX
    DevContainer --> Workspace
```

### 2. 请求与数据流（会话 → Agent → Workspace）

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as MGX Frontend
    participant G as Gateway (Apisix)
    participant O as OAuth2 Provider
    participant B as MGX API (FastAPI)
    participant Q as Celery
    participant A as Agent 容器
    participant W as Workspace
    participant DB as MongoDB

    U->>F: 登录 / 获取 Token
    F->>G: /oauth2/...
    G->>O: 代理
    O->>DB: 用户/授权数据
    O-->>F: Token

    U->>F: 在代码编辑器打开文件
    F->>G: /api/workspaces/{id}/files/...（携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>W: 读取文件内容
    W-->>B: 文件内容
    B-->>F: 返回文件内容

    U->>F: 保存文件
    F->>G: /api/workspaces/{id}/files/...（PUT，携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>W: 写入文件内容
    W-->>B: 写入结果
    B-->>F: 保存成功

    U->>F: 发起会话 / 聊天
    F->>G: HTTP（携带 Token）
    G->>B: 代理
    B->>O: 鉴权/校验 Token（JWKS/Introspection）
    O-->>B: 校验结果
    B->>DB: 会话 & 用户
    B->>Q: 投递 Agent 任务
    Q->>A: 创建 Agent 容器
    A->>W: 读写代码（挂载卷）
    A->>DB: 写入事件流
    Q->>DB: 轮询查询 FINISH 事件
    Q-->>B: 返回任务结果
    B->>DB: 读取事件流
    B->>F: SSE 流式推送
    F->>U: 展示 & 代码编辑
```

### 3. MGX Backend 与周边组件

```mermaid
flowchart LR
    subgraph MGX_API["MGX API (FastAPI)"]
        UserMgmt[用户管理]
        Chat[会话与聊天]
        GatewayMgmt[网关管理<br/>Apisix SDK]
        WorkspaceMgmt[Workspace 管理<br/>文件读写/代码编辑 API]
        DevContainerMgmt[app-dev-container 管理]
        AgentOrchestrator[Celery / Agent 编排]
        DBMgmt[数据库与存储管理]
        BuildDeploy[构建与部署]
    end

    OAuth2[OAuth2 Provider<br/>独立服务]
    Apisix[Apisix]
    Redis[(Redis)]
    MongoMGX[(MongoDB MGX)]
    MongoApps[(MongoDB Apps)]
    Docker[Docker<br/>容器与卷]
    Workspace[(Workspace<br/>本地挂载卷)]

    OAuth2 --> MongoMGX
    MGX_API -.->|鉴权/Token 校验| OAuth2
    UserMgmt --> MongoMGX
    Chat --> MongoMGX
    GatewayMgmt --> Apisix
    WorkspaceMgmt -->|读写文件| Workspace
    DevContainerMgmt --> Docker
    AgentOrchestrator --> Redis
    AgentOrchestrator --> Docker
    DBMgmt --> MongoMGX
    DBMgmt --> MongoApps
    BuildDeploy --> Docker
```

### 4. App 从开发到生产

```mermaid
flowchart TB
    subgraph Session["会话"]
        S1[一个 Session = 一个 App]
    end

    subgraph Dev["开发阶段"]
        W[Workspace<br/>前后端代码]
        DC[app-dev-container<br/>挂载 Workspace]
        DC --> W
    end

    subgraph Prod["生产阶段"]
        direction TB
        P1[全栈框架<br/>单容器]
        P2[前后端分离<br/>Backend 容器 + Frontend 容器]
    end

    Apisix[Apisix Gateway]

    S1 --> W
    W --> P1
    W --> P2
    Apisix --> DC
    Apisix --> P1
    Apisix --> P2
```

### 5. 部署与访问形态（App 单实例 + 子路径）

```mermaid
flowchart LR
    subgraph Internet["访问"]
        User[用户]
    end

    G[Apisix Gateway]

    subgraph Deploy["部署形态"]
        MGX_Fe[MGX Frontend]
        subgraph MGX_BE["MGX API 多实例"]
            MGX_Be1[mgx-api-1]
            MGX_Be2[mgx-api-2]
            MGX_BeN[mgx-api-n]
        end
        OAuth2[OAuth2 Provider]
        AppA_Container[App A 容器]
        AppB_Container[App B 容器]
    end

    User --> G
    G -->|"/"| MGX_Fe
    G -->|"/api/..."| MGX_Be1
    G -->|"/api/..."| MGX_Be2
    G -->|"/api/..."| MGX_BeN
    G -->|"/oauth2/..."| OAuth2
    G -->|"/apps/app-a/..."| AppA_Container
    G -->|"/apps/app-b/..."| AppB_Container

    MGX_Fe -.->|OAuth2 Client| OAuth2
    MGX_Be1 -.->|鉴权/Token 校验| OAuth2
    MGX_Be2 -.->|鉴权/Token 校验| OAuth2
    MGX_BeN -.->|鉴权/Token 校验| OAuth2
    AppA_Container -.->|OAuth2 Client| OAuth2
    AppB_Container -.->|OAuth2 Client| OAuth2
```

### 6. App 使用 MGX OAuth2 Provider（示意时序）

```mermaid
sequenceDiagram
    participant U as 用户
    participant A as App（Frontend/Backend）
    participant G as Apisix
    participant O as OAuth2 Provider（MGX）

    U->>A: 访问 App（/apps/{name}/...）
    A-->>U: 需要登录/无 Token
    U->>G: /oauth2/...（登录/授权）
    G->>O: 代理到 OAuth2 Provider
    O-->>U: 返回 Token（或回调到 App）
    U->>A: 携带 Token 重新访问
    A->>O: 校验 Token（例如 JWKS/Introspection）
    O-->>A: 校验结果/公钥
    A-->>U: 返回受保护资源
```

### 7. Agent 容器化架构详解

```mermaid
sequenceDiagram
    participant API as MGX API
    participant Celery as Celery Task
    participant Docker as Docker Engine
    participant Container as Agent Container
    participant DB as MongoDB (Events)
    participant WS as Workspace

    API->>Celery: 提交 run_team_agent_for_web_app_development 任务
    Celery->>Docker: 创建 Agent 容器
    Note over Docker: 传递环境变量<br/>SESSION_ID, WORKSPACE_ID, etc.
    Docker->>Container: 启动容器运行 run_agent.py
    Container->>DB: 写入 AGENT_START 事件
    
    loop Agent 执行
        Container->>WS: 读写代码文件
        Container->>DB: 写入流式事件<br/>MESSAGE_DELTA, TOOL_START, etc.
    end
    
    Container->>DB: 写入 FINISH 事件
    Container->>Container: 退出（自动删除）
    
    loop Celery 轮询监控
        Celery->>DB: 查询 FINISH 事件
        Celery->>Docker: 检查容器状态
    end
    
    Celery-->>API: 返回任务结果
```

#### Agent 容器化设计要点

1. **职责分离**
   - **Celery Task**: 负责容器的创建、启动、监控和超时处理
   - **Agent Container**: 负责实际的 agent 执行逻辑和事件写入
   - **FastAPI SSE**: 负责读取事件并流式推送给客户端

2. **容器生命周期**
   - 每个 session 创建一个独立的 agent 容器
   - 容器名称: `mgx-agent-{session_id}`
   - 容器运行完成后自动删除 (`remove=True`)
   - 支持资源限制（内存、CPU）

3. **环境变量传递**
   - `SESSION_ID`: Session ID
   - `WORKSPACE_ID`: Workspace ID
   - `FRAMEWORK`: 目标框架
   - `PROMPT`: 用户提示词
   - `MONGODB_URL`, `MONGODB_DB`: 数据库连接信息
   - `LANGFUSE_*`: Langfuse 配置（如果启用）

4. **监控机制**
   - Celery task 轮询 event 表查找 `FINISH` 事件
   - 同时检查容器状态（运行中/退出）
   - 支持超时机制（默认 30 分钟）
   - 超时后强制停止容器

5. **挂载卷**
   - Workspace 目录挂载到容器的 `/workspace`
   - Agent 可以直接读写代码文件

6. **网络配置**
   - 容器使用 bridge 网络模式
   - 可以访问 MongoDB 和其他服务

7. **镜像构建**
   - 使用统一镜像 `infra/Dockerfile.mgx`（mgx-api、celery-worker、agent 共用）
   - 使用 uv sync 安装依赖（清华源）
   - 镜像标签: `mgx:latest`（可配置）

# Tech stack
- MGX frontend: React SPA
- MGX backend: Fastapi
- Agent framework: langchain multiagents (https://github.com/FoundationAgents/langchain multiagents)
- agent runtime: docker container
- MGX Database: MongoDB
- Gateway: Apisix
- Container: Docker
- trace and logging: opentelemetry