# LangGraph 1.0.7 和 LangChain 1.2 迁移

**日期**: 2026-02-01  
**类型**: 重构  
**影响范围**: 所有 Agent 代码

## 变更概述

将项目从旧版 LangChain/LangGraph API 迁移到新版本：
- LangGraph 升级到 1.0.7
- LangChain 升级到 1.2

## 主要变更

### 1. Agent 创建 API 更新

**旧 API (已弃用):**
```python
from langchain.agents import AgentExecutor, create_react_agent
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),
    MessagesPlaceholder(variable_name="chat_history", optional=True),
    ("human", "{input}"),
    MessagesPlaceholder(variable_name="agent_scratchpad"),
])

agent = create_react_agent(llm, tools, prompt)
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True,
    callbacks=callbacks,
    max_iterations=15,
    handle_parsing_errors=True,
    return_intermediate_steps=True,
)
```

**新 API:**
```python
from langchain.agents import create_agent

agent = create_agent(
    model=llm,
    tools=tools,
    system_prompt=system_prompt,
)
```

### 2. Agent 调用格式更新

**旧格式:**
```python
result = agent.invoke({"input": "用户消息"})
output = result.get("output", "")
```

**新格式:**
```python
from langchain_core.messages import HumanMessage

result = agent.invoke({
    "messages": [HumanMessage(content="用户消息")]
})
output_messages = result.get("messages", [])
output = output_messages[-1].content if output_messages else ""
```

### 3. 返回类型变更

- **旧**: 返回 `AgentExecutor`
- **新**: 返回编译后的 LangGraph graph (`CompiledGraph`)
- **兼容性**: 两者都支持 `.invoke()` 方法，接口兼容

## 更新的文件

### Agent 文件
- ✅ `src/agents/web_app_team/agents/boss.py`
- ✅ `src/agents/web_app_team/agents/product_manager.py`
- ✅ `src/agents/web_app_team/agents/architect.py`
- ✅ `src/agents/web_app_team/agents/project_manager.py`
- ✅ `src/agents/web_app_team/agents/engineer.py`
- ✅ `src/agents/web_app_team/agents/qa.py`

### 工厂和工作流文件
- ✅ `src/agents/agent_factory.py`
  - 更新 `create_code_generation_agent()`
  - 更新 `create_planning_agent()`
  - 移除 `CompiledGraph` 导入
  
- ✅ `src/agents/web_app_team/graph.py`
  - 更新所有节点函数以使用新的消息格式
  - 更新文档字符串

### 团队文件
- ✅ `src/agents/web_app_team/team.py`
  - 移除 `CompiledGraph` 导入
  - 注释已更新

### RAG 文件
- ✅ `src/agents/web_app_team/rag/retriever.py`
  - 更新 retriever 导入为 `langchain_classic`

### 依赖配置
- ✅ `pyproject.toml`
  - 添加 `langchain-classic>=0.1.0` 依赖

## 优势

1. **简化的 API**: 减少了样板代码
2. **更好的类型安全**: 统一使用 messages 格式
3. **官方推荐**: 这是 LangChain v1 推荐的方式
4. **未来兼容**: 为后续版本升级做好准备

## 向后兼容性

- LangGraph 的 `StateGraph` 和 `END` 导入保持不变
- 虽然旧 API 被标记为弃用，但仍然可用
- 新旧 API 的 `.invoke()` 接口兼容，调用方式相同

## 测试状态

- ✅ 所有文件语法检查通过
- ✅ 所有导入测试通过
- ✅ Agent 创建测试通过
- ✅ 工作流图测试通过
- ✅ 团队工厂测试通过

**测试结果**: 4/4 测试通过 🎉

## 额外发现和修复

### 1. `CompiledGraph` 导入问题
**问题**: `CompiledGraph` 不再从 `langgraph.graph` 导出  
**解决**: 移除显式导入，使用动态类型

### 2. Retriever 导入问题
**问题**: `langchain.retrievers` 在 v1 中被移除  
**解决**: 
- 添加 `langchain-classic` 依赖
- 更新导入为 `from langchain_classic.retrievers import ...`

## 后续工作

1. ✅ 进行基本导入和集成测试 - **已完成**
2. 更新单元测试以匹配新的 API
3. 进行端到端测试验证运行时行为
4. 监控生产环境性能
5. 考虑使用新的 middleware 功能进行高级定制

## 参考文档

- [LangGraph v1 迁移指南](https://docs.langchain.com/oss/python/migrate/langgraph-v1)
- [LangChain v1 迁移指南](https://docs.langchain.com/oss/python/migrate/langchain-v1)
- [LangChain Agents 文档](https://docs.langchain.com/oss/python/langchain/agents)
